<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Supabase Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f1115; color: #e0e0e0; min-height: 100vh; display: flex; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; }
        .container-box { max-width: 700px; width: 100%; padding: 20px; }
        .card-dark { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 2rem; }
        .form-control { background-color: #0d1117; border-color: #30363d; color: #fff; }
        .form-control:focus { background-color: #0d1117; border-color: #3ecf8e; color: #fff; box-shadow: 0 0 0 0.25rem rgba(62, 207, 142, 0.25); }
        .btn-supabase { background-color: #3ecf8e; color: #0f1115; font-weight: bold; border: none; }
        .btn-supabase:hover { background-color: #34b27b; color: #fff; }
    </style>
</head>
<body>

    <div class="container-box">
        
        <div id="loginSection" class="card-dark text-center">
            <h3 class="mb-4 text-white">Admin Access</h3>
            <p class="text-secondary">Please login to manage portfolio</p>
            <button id="btnLogin" class="btn btn-light w-100 mb-2">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" class="me-2"> 
                Login with Google
            </button>
            <small class="text-muted d-block mt-2">Make sure Google Auth is enabled in Supabase Dashboard</small>
        </div>

        <div id="adminContent" class="card-dark" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white">üöÄ Upload Project</h4>
                <button id="btnLogout" class="btn btn-outline-danger btn-sm">Sign Out</button>
            </div>

            <form id="uploadForm">
                <div class="mb-3">
                    <label>Title *</label>
                    <input type="text" id="pTitle" class="form-control" required>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label>Tools</label>
                        <input type="text" id="pTools" class="form-control" placeholder="SPSS, Python">
                    </div>
                    <div class="col-6 mb-3">
                        <label>Sample Size</label>
                        <input type="text" id="pSample" class="form-control" placeholder="N=400">
                    </div>
                </div>
                <div class="mb-3">
                    <label>Abstract *</label>
                    <textarea id="pDesc" class="form-control" rows="4" required></textarea>
                </div>
                <div class="mb-3">
                    <label>Link URL</label>
                    <input type="url" id="pLink" class="form-control">
                </div>

                <hr class="border-secondary">

                <div class="mb-3">
                    <label>üì∏ Cover Image</label>
                    <input type="file" id="pFileImg" class="form-control" accept="image/*">
                </div>
                <div class="mb-3">
                    <label>üìÑ PDF Full Paper</label>
                    <input type="file" id="pFilePdf" class="form-control" accept="application/pdf">
                </div>

                <button type="submit" class="btn btn-supabase w-100 mt-2">Upload to Database</button>
            </form>
            <div class="mt-3 text-center">
                <a href="index.html" class="text-secondary text-decoration-none">View Portfolio</a>
            </div>
        </div>
    </div>

    <script>
        // --- ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è ---
        const SUPABASE_URL = 'https://cdzaulnuxonegxxxlhvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkemF1bG51eG9uZWd4eHhsaHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTQxNTgsImV4cCI6MjA4MzAzMDE1OH0.woMJFe0XN5PEQvZ0VMqf3gMcPl9HmjsAvcrdvsSaYWM'; 
        // -------------------------

        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_EMAIL = "mrkongpop1999@gmail.com";

        // Check Login Status
        async function checkUser() {
            const { data: { session } } = await sb.auth.getSession();
            if (session && session.user.email === ADMIN_EMAIL) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminContent').style.display = 'none';
                if(session) sb.auth.signOut(); // Force logout if not admin
            }
        }
        checkUser();

        // Login Button
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const { error } = await sb.auth.signInWithOAuth({ provider: 'google' });
            if (error) alert("Login Error: " + error.message);
        });

        // Logout Button
        document.getElementById('btnLogout').addEventListener('click', async () => {
            await sb.auth.signOut();
            window.location.reload();
        });

        // Upload Logic
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Uploading... (Supabase is fast!)";

            try {
                const imgFile = document.getElementById('pFileImg').files[0];
                const pdfFile = document.getElementById('pFilePdf').files[0];
                
                let imgUrl = null;
                let pdfUrl = null;
                const timestamp = Date.now();

                // 1. Upload Image
                if (imgFile) {
                    const { data, error } = await sb.storage.from('files').upload(`covers/${timestamp}_${imgFile.name}`, imgFile);
                    if (error) throw error;
                    const { data: { publicUrl } } = sb.storage.from('files').getPublicUrl(data.path);
                    imgUrl = publicUrl;
                }

                // 2. Upload PDF
                if (pdfFile) {
                    const { data, error } = await sb.storage.from('files').upload(`pdfs/${timestamp}_${pdfFile.name}`, pdfFile);
                    if (error) throw error;
                    const { data: { publicUrl } } = sb.storage.from('files').getPublicUrl(data.path);
                    pdfUrl = publicUrl;
                }

                // 3. Insert Data
                const { error } = await sb.from('research_projects').insert({
                    title: document.getElementById('pTitle').value,
                    tools: document.getElementById('pTools').value,
                    description: document.getElementById('pDesc').value,
                    sample_size: document.getElementById('pSample').value,
                    link_url: document.getElementById('pLink').value,
                    image_url: imgUrl,
                    pdf_url: pdfUrl
                });

                if (error) throw error;

                alert("‚úÖ Upload Successfully!");
                e.target.reset();

            } catch (err) {
                console.error(err);
                alert("‚ùå Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });
    </script>
</body>
</html>